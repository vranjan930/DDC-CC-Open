<script>
function smartClassify(query, title, author, subjects = []) {
  const text = (
    query + " " +
    title + " " +
    author + " " +
    subjects.join(" ")
  ).toLowerCase();

  /* ---------- DDC LOGIC ---------- */
  let ddc = "000";
  let ddcNote = "General works (fallback)";

  if (text.includes("library") || text.includes("librarian")) {
    ddc = "020.1";
    ddcNote = "Library science â€“ theory & principles";
  }
  else if (text.includes("classification")) {
    ddc = "025.42";
    ddcNote = "Classification and indexing";
  }
  else if (text.includes("information retrieval")) {
    ddc = "025.04";
    ddcNote = "Information storage and retrieval";
  }
  else if (text.includes("philosophy") || text.includes("rousseau")) {
    ddc = "194";
    ddcNote = "Modern Western philosophy (France)";
  }
  else if (text.includes("political")) {
    ddc = "320";
    ddcNote = "Political science";
  }

  /* ---------- COLON CLASSIFICATION (SIMPLIFIED PMEST) ---------- */
  let cc = "Z";
  let ccNote = "General knowledge (fallback)";

  if (text.includes("library")) {
    cc = "2;44";
    ccNote = "P: Library Science | E: Principles";
  }
  else if (text.includes("classification")) {
    cc = "2;42";
    ccNote = "P: Library Science | E: Classification";
  }
  else if (text.includes("information retrieval")) {
    cc = "2;7";
    ccNote = "P: Library Science | E: Retrieval processes";
  }
  else if (text.includes("rousseau") || text.includes("philosophy")) {
    cc = "A;6";
    ccNote = "P: Philosophy | E: Political thought";
  }

  return { ddc, ddcNote, cc, ccNote };
}

async function searchBook() {
  const q = document.getElementById("query").value.trim();
  const status = document.getElementById("status");
  const result = document.getElementById("result");

  if (!q) {
    status.innerText = "Please enter ISBN, Title, or Author.";
    return;
  }

  status.innerText = "Searching Open Library...";
  result.innerHTML = "";

  let url = "";
  let isISBN = /^[0-9Xx-]{10,17}$/.test(q);

  if (isISBN) {
    url = "https://openlibrary.org/api/books?bibkeys=ISBN:" + q + "&format=json&jscmd=data";
  } else {
    url = "https://openlibrary.org/search.json?q=" + encodeURIComponent(q);
  }

  const response = await fetch(url);
  const data = await response.json();

  let title = "", author = "", subjects = [];

  if (data.docs) {
    title = data.docs[0].title || "";
    author = data.docs[0].author_name?.[0] || "";
    subjects = data.docs[0].subject || [];
  } else {
    const key = Object.keys(data)[0];
    title = data[key].title || "";
    author = data[key].authors?.[0]?.name || "";
    subjects = data[key].subjects || [];
  }

  const cls = smartClassify(q, title, author, subjects);

  status.innerText = "Result found:";

  result.innerHTML = `
    <h3>${title}</h3>
    <p><strong>Author:</strong> ${author || "N/A"}</p>
    <p><strong>Subjects:</strong> ${subjects.slice(0,5).join(", ") || "N/A"}</p>

    <hr>
    <h4>ðŸ“˜ Dewey Decimal Classification (Suggested)</h4>
    <p><strong>${cls.ddc}</strong> â€” ${cls.ddcNote}</p>

    <h4>ðŸ“— Colon Classification (Suggested)</h4>
    <p><strong>${cls.cc}</strong> â€” ${cls.ccNote}</p>

    <p><em>Generated using hybrid queryâ€“metadataâ€“rule logic.</em></p>
  `;
}
</script>
